# BatteryCap

macOS 菜单栏电池管理工具：支持电量锁定、充电上限与状态监控。

## 功能概览

- 菜单栏常驻：显示电量、供电来源、充电状态、循环次数与更新时间
- 电量锁定与充电上限：达到上限后暂停充电，低于下限后恢复
- 立即刷新：手动触发一次电池信息与控制状态刷新
- SMC 写入状态提示：未授权时提供“授权写入”按钮
- 设置面板：开机自启动、退出时保持当前状态、恢复系统默认、退出

## 开发规划

- [ ] 软件和服务卸载脚本
- [ ] App图标
- [ ] 状态栏图标
- [ ] 状态栏图标动态变化
我想让本软件的状态栏图标随着软件设置和电池状态的变化而改变：
电量锁定控制图标实心和空心，电量锁定开为实心，关为空心
电池状态控制图标里面显示什么：正在充电为闪电图标 / 充电暂停为空白图标 / 放电中为减加图标
排列组合共有6种状态：
锁定开，正在充电：bolt.batteryblock.fill
锁定关，正在充电：bolt.batteryblock
锁定开，充电暂停：batteryblock.fill
锁定关，充电暂停：batteryblock
锁定开，放电中：minus.plus.batteryblock.fill
锁定关，放电中：minus.plus.batteryblock
- [ ] 界面上卸载和安装helper服务按钮

## 运行（开发）

```bash
swift run
```

## 本地安装写入组件（必须）

```bash
scripts/install-helper.sh
```

安装过程中会弹出管理员授权，请输入密码。
也可以在应用内点击“授权写入”触发安装（要求项目根目录存在并可执行该脚本）。

## 卸载/清理写入组件

仅卸载特权 Helper：

```bash
scripts/uninstall-helper.sh
```

卸载并清理用户配置：

```bash
scripts/uninstall-helper.sh -p
```

完全卸载（移除 App + 清理用户配置）：

```bash
scripts/uninstall-helper.sh -x
```

查看帮助：

```bash
scripts/uninstall-helper.sh -h
```

## SMC 诊断（命令行）

```bash
swift run BatteryCap -- --diagnose
```

```bash
swift run BatteryCap -- --smc-diagnose
```

```bash
BATTERYCAP_DIAG=1 swift run
```

如提示 Helper 诊断接口不可用，请重新运行 `scripts/install-helper.sh` 以更新特权组件。

## 工作原理（简述）

- 使用“充电开关键”控制充电开/关：
  - Tahoe 固件：`CHTE`（4 字节）
  - 旧固件：`CH0B` + `CH0C`（各 1 字节）
- 充电控制统一通过特权 Helper 写入，直接写入只用于能力检测。
- 当“电量锁定”开启且电量达到上限时，会暂停充电；电量低于上限时再恢复充电。
- 退出行为由“退出时保持当前状态”开关决定：关闭时退出会恢复正常充电。

## 充电逻辑（行为规则）

- 上限范围为 50%~100%，默认上限为 80%。
- 逻辑仅影响“停充/允充”，**不会强制放电**。
- 若设备未接外部电源，开关状态不会改变放电行为。

假设当前电量为 `current`，目标上限为 `limit`：

- **电量锁定 = 关闭**：不干预充电，系统按默认策略运行。
- **电量锁定 = 开启**：采用 ±1% 的阈值滞回（默认）：
  - 当 `current >= limit + 1` 时，停止充电（关闭充电开关）。
  - 当 `current <= limit - 1` 时，允许充电（打开充电开关）。
  - 当 `limit - 1 < current < limit + 1` 时，保持上一次充电状态。

例如：插电，设置上限 80%，但当前电量为 90%，此时会立刻**停止充电**，电量会自然缓慢下降到阈值附近后再恢复充电。

## 设置入口

主界面“控制”区包含电量锁定开关、最高电量滑块与“立即刷新”按钮。
点击“设置”后会弹出设置面板，包含：

- 开机自启动
- 退出时保持当前状态
- 恢复系统默认
- 退出

## 开机自启动

使用系统推荐的 `SMAppService.mainApp` 注册登录项。
在“系统设置 → 登录项”中可能需要手动允许。
如提示“请将应用放入应用程序文件夹后重试”，请将 App 移动到“应用程序”。

## 常见问题

1. **提示“权限不足”**
   - 先运行 `scripts/install-helper.sh` 重新安装 Helper
   - 或在应用内点击“授权写入”触发安装
   - 运行 `swift run BatteryCap -- --diagnose`，确认 `SMC 状态: 已启用特权写入`
2. **锁定无效/无响应**
   - 确认设备处于外接电源
   - 将上限设置为低于当前电量，再开启“电量锁定”验证
3. **开机自启动未生效**
   - 确认应用位于“应用程序”文件夹
   - 在“系统设置 → 登录项”中允许 BatteryCap
