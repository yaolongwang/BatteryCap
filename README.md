# BatteryCap

macOS 菜单栏电池管理工具：支持电量锁定、充电上限与状态监控。

## 运行（开发）
```bash
swift run
```

## 本地安装写入组件（必须）
```bash
scripts/install-helper.sh
```
安装过程中会弹出管理员授权，请输入密码。

## SMC 诊断（命令行）
```bash
swift run BatteryCap -- --diagnose
```
如提示 Helper 诊断接口不可用，请重新运行 `scripts/install-helper.sh` 以更新特权组件。

## 工作原理（简述）
- 使用“充电开关键”控制充电开/关：
  - Tahoe 固件：`CHTE`（4 字节）
  - 旧固件：`CH0B` + `CH0C`（各 1 字节）
- 当“电量锁定”开启且电量达到上限时，会暂停充电；电量低于上限时再恢复充电。
- 退出行为由“退出时保持当前状态”开关决定：关闭时退出会恢复正常充电。

## 充电逻辑（行为规则）
假设当前电量为 `current`，目标上限为 `limit`：
- **电量锁定 = 关闭**：不干预充电，系统按默认策略运行。
- **电量锁定 = 开启 且 current < limit**：允许充电（打开充电开关）。
- **电量锁定 = 开启 且 current >= limit**：停止充电（关闭充电开关）。

说明：
- 该逻辑只会“停充/允充”，**不会强制放电**。
- 例如：你插电，设置上限 80%，但当前电量 90%，此时会立刻**停止充电**，电量会自然缓慢下降到阈值附近后再恢复充电。
- 若设备未接外部电源，开关状态不会改变放电行为。

## 已验证环境（2026-01-28）
设备：Mac16,13 / macOS 26.2 (Build 25C56)

- `CHTE` 存在并可读取
- 通过特权 Helper 写入充电开关路径可用

## 开机自启动
使用系统推荐的 `SMAppService.mainApp` 注册登录项。
在“系统设置 → 登录项”中可能需要手动允许。

## SIP 状态（建议保持开启）
本项目运行**不需要关闭 SIP**。建议保持 `System Integrity Protection: enabled`。

如需确认或恢复：
```bash
csrutil status
```

恢复默认（进入恢复模式后执行）：
```bash
csrutil enable
```

## 常见问题
1. **提示“权限不足”**  
   - 先运行 `scripts/install-helper.sh` 重新安装 Helper  
   - 运行 `swift run BatteryCap -- --diagnose`，确认 `SMC 状态: 已启用特权写入`
2. **锁定无效/无响应**  
   - 确认设备处于外接电源  
   - 将上限设置为低于当前电量，再开启“电量锁定”验证
3. **开机自启动未生效**  
   - 确认应用位于“应用程序”文件夹  
   - 在“系统设置 → 登录项”中允许 BatteryCap
